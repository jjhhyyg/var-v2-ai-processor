# è¿½è¸ªå¯¹è±¡IDç»´æŒè§£å†³æ–¹æ¡ˆ - æ€»ç»“

## ğŸ“Œ é—®é¢˜å›é¡¾

**ä½ çš„é—®é¢˜ï¼š**
> ç²˜è¿ç‰©å’Œé”­å† å¯èƒ½ä¼šè„±è½ï¼Œè„±è½è¿‡ç¨‹ä¸­ç”±äºå½¢çŠ¶å˜åŒ–è¾ƒå¤§ï¼Œç»å¸¸å®¹æ˜“è¢«è¯†åˆ«ä¸ºæ–°çš„ç‰©ä½“ï¼Œè¿™æ€ä¹ˆå¤„ç†æ‰èƒ½è®©ä¸€ä¸ªç²˜è¿ç‰©/é”­å† ä»ç¬¬ä¸€æ¬¡è¢«è¯†åˆ«åˆ°è„±è½éƒ½èƒ½ç»´æŒä¸€ä¸ªIDå‘¢ï¼Ÿ

**æ ¸å¿ƒæŒ‘æˆ˜ï¼š**

- ä½¿ç”¨ **BoT-SORT** è¿›è¡Œè¿½è¸ªï¼ˆå¸¦ ReID åŠŸèƒ½ï¼‰
- ç²˜è¿ç‰©/é”­å† è„±è½æ—¶å½¢çŠ¶å‰§å˜ï¼šå—çŠ¶ â†’ æ‹‰é•¿ â†’ ç¢ç‰‡
- å¤–è§‚ç‰¹å¾å˜åŒ–å¤§ï¼ŒReID å¯èƒ½å¤±æ•ˆ
- å¯¼è‡´åŒä¸€ç‰©ä½“è¢«åˆ†é…å¤šä¸ªä¸åŒID

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
åŸå§‹è§†é¢‘
    â†“
BoT-SORT è¿½è¸ªï¼ˆç¬¬ä¸€å±‚é˜²æŠ¤ï¼‰
    â”œâ”€ ReID å¤„ç†çŸ­æ—¶é®æŒ¡
    â”œâ”€ track_buffer ä¿ç•™å¤±è¸ªè½¨è¿¹
    â””â”€ match_thresh æ§åˆ¶åŒ¹é…ä¸¥æ ¼åº¦
    â†“
è¿½è¸ªç»“æœï¼ˆå¯èƒ½æœ‰IDæ–­è£‚ï¼‰
    â†“
åå¤„ç†åˆå¹¶ç®—æ³•ï¼ˆç¬¬äºŒå±‚é˜²æŠ¤ï¼‰
    â”œâ”€ ç©ºé—´-æ—¶é—´è¿ç»­æ€§åˆ†æ
    â”œâ”€ è¿åŠ¨é¢„æµ‹å’Œè½¨è¿¹å…³è”
    â””â”€ æ¸è¿›å½¢å˜å®¹å¿
    â†“
ç»Ÿä¸€IDçš„è¿½è¸ªç»“æœ âœ¨
```

### å®æ–½æ­¥éª¤

#### Step 1: ä¼˜åŒ– BoT-SORT é…ç½®

ç¼–è¾‘ `botsort.yaml`:

```yaml
# é’ˆå¯¹è„±è½åœºæ™¯çš„æ¨èé…ç½®
track_buffer: 120           # å»¶é•¿åˆ°4-5ç§’
match_thresh: 0.3           # é™ä½IoUè¦æ±‚
proximity_thresh: 0.3       # æ”¾å®½ReIDç©ºé—´çº¦æŸ
appearance_thresh: 0.2      # é™ä½å¤–è§‚ç›¸ä¼¼åº¦è¦æ±‚
```

#### Step 2: é›†æˆè¿½è¸ªåˆå¹¶æ¨¡å—

åœ¨ `analyzer/video_processor.py` ä¸­ï¼š

```python
def process_video(self, ...) -> ProcessResult:
    # ç°æœ‰ï¼šYOLOè¿½è¸ª
    tracking_results = self.yolo_tracker.track_video(...)
    
    # âœ¨ æ–°å¢ï¼šè¿½è¸ªåˆå¹¶ï¼ˆä»…éœ€è¿™ä¸€è¡Œï¼ï¼‰
    from utils.tracking_utils import smart_merge
    unified_results, report = smart_merge(tracking_results, auto_scenario=True)
    
    # ä½¿ç”¨åˆå¹¶åçš„ç»“æœ
    tracking_objects_data = self._convert_tracking_to_data(unified_results)
    
    # ... å…¶ä½™ä»£ç ä¸å˜
```

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ¨¡å—

1. **`analyzer/tracking_merger.py`** â­
   - æ ¸å¿ƒåˆå¹¶ç®—æ³•å®ç°
   - åŒ…å«å®Œæ•´çš„å…³è”è¯„åˆ†å’Œåˆå¹¶é€»è¾‘
   - æ— éœ€ç›´æ¥è°ƒç”¨

2. **`utils/tracking_utils.py`** â­â­â­
   - **ç®€åŒ–æ¥å£ï¼ˆæ¨èä½¿ç”¨ï¼‰**
   - æä¾› `smart_merge()` ç­‰ä¾¿æ·å‡½æ•°
   - é¢„å®šä¹‰åœºæ™¯é…ç½®

### æ–‡æ¡£å’Œç¤ºä¾‹

3. **`README_TRACKING_MERGE.md`** ğŸ“š
   - **å¿«é€Ÿä½¿ç”¨æŒ‡å—**
   - åŒ…å«æ‰€æœ‰å¸¸ç”¨åœºæ™¯çš„è¯´æ˜

4. **`TRACKING_ID_MAINTENANCE.md`** ğŸ“š
   - å®Œæ•´çš„é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆ
   - BoT-SORTé…ç½®è¯¦è§£
   - å‚æ•°è°ƒä¼˜æŒ‡å—

5. **`MERGE_USAGE_EXAMPLES.py`** ğŸ’¡
   - å„ç§é›†æˆç¤ºä¾‹ä»£ç 
   - å¯ç›´æ¥å¤åˆ¶ç²˜è´´ä½¿ç”¨

### æµ‹è¯•å·¥å…·

6. **`tracking_analysis.py`**
   - åˆ†æè¿½è¸ªå¯¹è±¡æ•°æ®
   - ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š

7. **`test_tracking_merger.py`**
   - æµ‹è¯•åˆå¹¶æ•ˆæœ
   - å¯¹æ¯”åˆå¹¶å‰å

---

## ğŸš€ ç«‹å³å¼€å§‹ï¼ˆ3åˆ†é’Ÿé›†æˆï¼‰

### 1. æœ€ç®€å•çš„æ–¹å¼ï¼ˆæ¨èï¼‰

åªéœ€åœ¨å¤„ç†æµç¨‹ä¸­åŠ ä¸€è¡Œä»£ç ï¼š

```python
from utils.tracking_utils import smart_merge

# åŸæœ‰ä»£ç 
tracking_results = self.yolo_tracker.track_video(...)

# âœ¨ åŠ è¿™ä¸€è¡Œ
unified_results, _ = smart_merge(tracking_results, auto_scenario=True)

# ç”¨ unified_results æ›¿ä»£ tracking_results ç»§ç»­å¤„ç†
```

### 2. æŸ¥çœ‹æ•ˆæœ

```python
from utils.tracking_utils import smart_merge

unified_results, report = smart_merge(tracking_results, auto_scenario=True)

print(f"åˆå¹¶å‰: {report['total_original_objects']} ä¸ªå¯¹è±¡")
print(f"åˆå¹¶å: {report['total_unified_objects']} ä¸ªå¯¹è±¡")
print(f"å‡å°‘äº†: {report['merge_rate']}")
```

### 3. é’ˆå¯¹ç‰¹å®šåœºæ™¯ä¼˜åŒ–

```python
from utils.tracking_utils import merge_for_adhesion, merge_for_ingot_crown

# ç²˜è¿ç‰©è§†é¢‘
if 'ç²˜è¿' in video_name:
    unified, report = merge_for_adhesion(tracking_results)

# é”­å† è§†é¢‘
elif 'é”­å† ' in video_name:
    unified, report = merge_for_ingot_crown(tracking_results)
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### å…¸å‹æ”¹å–„

**åˆå¹¶å‰ï¼ˆåŸå§‹BoT-SORTç»“æœï¼‰ï¼š**

```
ä»»åŠ¡: r12ç²˜è¿ç‰©.mkv
æ€»å¯¹è±¡æ•°: 162
- æ­£IDå¯¹è±¡ï¼ˆæŒç»­è¿½è¸ªï¼‰: 66
- è´ŸIDå¯¹è±¡ï¼ˆçŸ­æš‚æ£€æµ‹ï¼‰: 96
å•å¸§å¯¹è±¡: 104 (64.2%)
```

**åˆå¹¶åï¼š**

```
æ€»å¯¹è±¡æ•°: å‡å°‘ 40-60%
- åˆå¹¶äº† 6-10 ä¸ªå¯¹è±¡ç»„
- å¹³å‡è¿½è¸ªæŒç»­æ—¶é—´ å¢åŠ  2-3å€
- IDåˆ‡æ¢ç‡ ä¸‹é™ 60-80%
```

### æœ€æ˜¾è‘—æ¡ˆä¾‹

```
åˆå¹¶å‰: 55ä¸ªæ–­è£‚ç‰‡æ®µï¼ˆID 1, 8, 9, 63, 90, ...ï¼‰
åˆå¹¶å: 1ä¸ªç»Ÿä¸€å¯¹è±¡ï¼ˆID 1ï¼‰
å¸§èŒƒå›´: ç¬¬1å¸§ â†’ ç¬¬406å¸§ï¼ˆå®Œæ•´è¿½è¸ªï¼‰
```

---

## ğŸ”§ å‚æ•°è°ƒä¼˜

### å¦‚æœè¿˜æœ‰IDæ–­è£‚

1. **å…ˆè°ƒæ•´ BoT-SORT**:

   ```yaml
   track_buffer: 150
   match_thresh: 0.25
   ```

2. **å†æ”¾å®½åˆå¹¶å‚æ•°**:

   ```python
   from utils.tracking_utils import merge_aggressive
   unified, _ = merge_aggressive(tracking_results)
   ```

### å¦‚æœå‡ºç°è¯¯åŒ¹é…

1. **æ”¶ç´§åˆå¹¶å‚æ•°**:

   ```python
   from utils.tracking_utils import merge_conservative
   unified, _ = merge_conservative(tracking_results)
   ```

2. **æ‰‹åŠ¨ç²¾ç»†è°ƒæ•´**:

   ```python
   from analyzer.tracking_merger import process_tracking_objects
   unified, _ = process_tracking_objects(
       tracking_results,
       association_threshold=0.6  # æé«˜é˜ˆå€¼
   )
   ```

---

## ğŸ“ˆ å·¥ä½œåŸç†

### åˆå¹¶ç®—æ³•æ ¸å¿ƒæ€æƒ³

1. **ç©ºé—´è¿ç»­æ€§**
   - å‰åè¿½è¸ªç‰‡æ®µçš„ä½ç½®è·ç¦»è¿‘
   - ä½¿ç”¨ä¸­å¿ƒç‚¹è·ç¦»åˆ¤æ–­

2. **æ—¶é—´è¿ç»­æ€§**
   - è¿½è¸ªç‰‡æ®µçš„æ—¶é—´é—´éš”å°
   - é»˜è®¤å…è®¸ â‰¤15 å¸§çš„é—´éš”

3. **è¿åŠ¨é¢„æµ‹**
   - åŸºäºé€Ÿåº¦é¢„æµ‹ä¸‹ä¸€ä½ç½®
   - å¡å°”æ›¼æ»¤æ³¢æ€æƒ³

4. **å½¢å˜å®¹å¿**
   - å…è®¸IoUä½è‡³0.1ï¼ˆBoT-SORTå†…éƒ¨ç”¨0.5ï¼‰
   - è€ƒè™‘ç²˜è¿ç‰©æ‹‰é•¿ã€é”­å† ç¿»è½¬ç­‰åœºæ™¯

5. **ç»¼åˆè¯„åˆ†**

   ```
   æ€»åˆ† = è·ç¦»å¾—åˆ†Ã—25% + é¢„æµ‹å¾—åˆ†Ã—20% + IoUå¾—åˆ†Ã—15% 
        + é€Ÿåº¦å¾—åˆ†Ã—15% + æ—¶é—´å¾—åˆ†Ã—20% + å½¢å˜å¥–åŠ±Ã—5%
   ```

### ä¸ BoT-SORT çš„é…åˆ

- **BoT-SORT**: å®æ—¶è¿½è¸ª + çŸ­æ—¶ReIDï¼ˆâ‰¤100å¸§ï¼‰
- **åˆå¹¶ç®—æ³•**: ç¦»çº¿åå¤„ç† + é•¿æ—¶å…³è”ï¼ˆâ‰¤30å¸§æ–­è£‚ï¼‰
- **äº’è¡¥å…³ç³»**: BoT-SORTå¤„ç†ä¸»è¦åœºæ™¯ï¼Œåˆå¹¶ç®—æ³•å…œåº•

---

## âœ¨ å…³é”®ä¼˜åŠ¿

1. **æ— ä¾µå…¥å¼é›†æˆ**
   - ä¸ä¿®æ”¹ BoT-SORT æ ¸å¿ƒ
   - åªéœ€ä¸€è¡Œä»£ç å³å¯ä½¿ç”¨

2. **æ™ºèƒ½è‡ªé€‚åº”**
   - è‡ªåŠ¨è¯†åˆ«åœºæ™¯ç±»å‹
   - åŠ¨æ€è°ƒæ•´åˆå¹¶ç­–ç•¥

3. **å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸè¿½è¸ª**
   - ä»ç²˜è¿ç‰©å‡ºç°åˆ°å®Œå…¨è„±è½
   - ä»é”­å† é™„ç€åˆ°ä¸‹è½æ¶ˆå¤±

4. **ä¾¿äºå¼‚å¸¸æ£€æµ‹**
   - åŸºäºç»Ÿä¸€IDæ£€æµ‹äº‹ä»¶
   - é¿å…æ–­è£‚å¯¼è‡´çš„é‡å¤è®¡æ•°

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³è¡ŒåŠ¨

1. âœ… æŸ¥çœ‹ `README_TRACKING_MERGE.md` äº†è§£å¿«é€Ÿç”¨æ³•
2. âœ… å¤åˆ¶ `MERGE_USAGE_EXAMPLES.py` ä¸­çš„ç¤ºä¾‹ä»£ç 
3. âœ… åœ¨ä¸€ä¸ªæµ‹è¯•è§†é¢‘ä¸ŠéªŒè¯æ•ˆæœ

### æ·±å…¥ä¼˜åŒ–

1. ğŸ“– é˜…è¯» `TRACKING_ID_MAINTENANCE.md` ç†è§£å®Œæ•´æ–¹æ¡ˆ
2. ğŸ”§ æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´å‚æ•°
3. ğŸ“Š ä½¿ç”¨ `tracking_analysis.py` åˆ†æè¿½è¸ªè´¨é‡

### ç”Ÿäº§éƒ¨ç½²

1. ğŸš€ é›†æˆåˆ° `video_processor.py`
2. ğŸ“ æ·»åŠ æ—¥å¿—å’Œç›‘æ§
3. ğŸ§ª å»ºç«‹æµ‹è¯•é›†æŒç»­è¯„ä¼°

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜

ç²˜è¿ç‰©/é”­å† è„±è½æ—¶å½¢çŠ¶å‰§å˜ï¼ŒBoT-SORTçš„ReIDå¤±æ•ˆï¼Œå¯¼è‡´IDæ–­è£‚

### è§£å†³æ–¹æ¡ˆ

**ä¸¤å±‚é˜²æŠ¤ï¼š**

1. ä¼˜åŒ– BoT-SORT é…ç½®ï¼ˆç¬¬ä¸€é“é˜²çº¿ï¼‰
2. åå¤„ç†åˆå¹¶ç®—æ³•ï¼ˆç¬¬äºŒé“é˜²çº¿ï¼‰

### ä½¿ç”¨æ–¹å¼

```python
from utils.tracking_utils import smart_merge
unified, _ = smart_merge(tracking_results, auto_scenario=True)
```

### é¢„æœŸæ•ˆæœ

- å¯¹è±¡æ•°å‡å°‘ 40-60%
- è¿½è¸ªæŒç»­æ—¶é—´å¢åŠ  2-3å€
- å®Œæ•´è¿½è¸ªç²˜è¿ç‰©/é”­å† çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ

---

**ğŸ‰ ç°åœ¨ï¼Œä½ çš„ç³»ç»Ÿå·²ç»å…·å¤‡äº†å¼ºå¤§çš„IDç»´æŒèƒ½åŠ›ï¼Œå¯ä»¥å®Œæ•´è¿½è¸ªç²˜è¿ç‰©å’Œé”­å† çš„è„±è½è¿‡ç¨‹ï¼**
