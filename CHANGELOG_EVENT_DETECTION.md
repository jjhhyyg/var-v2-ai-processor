# 异常事件检测逻辑更新说明

## 更新日期

2025-10-04

## 主要变更

### 1. 修正持续性异常事件的检测逻辑

**问题描述：**
之前的实现中，持续性异常事件（辉光、边弧、爬弧、熔池未到边）的检测逻辑不正确，没有正确使用物体的起始帧和结束帧。

**解决方案：**

- 移除了 `continuous_events` 字典，不再在每帧更新持续事件状态
- 改为在物体消失时（track结束），根据该物体的 `first_frame` 和 `last_frame` 生成事件
- 事件的 `startFrame` 和 `endFrame` 现在正确对应物体出现和消失的帧号

**影响的事件类型：**

- 辉光 (GLOW)
- 边弧/侧弧 (SIDE_ARC)
- 爬弧 (CLIMBING_ARC)
- 熔池未到边 (POOL_NOT_EDGE)

**代码位置：**

- `analyzer/event_detector.py` - `process_detections()` 方法
- `analyzer/event_detector.py` - `finalize_events()` 方法

---

### 2. 改进粘连物脱落位置判断逻辑

**问题描述：**
之前只是简单根据y坐标判断脱落位置，没有考虑机位和水平运动方向。

**新的判断逻辑：**

#### 2.1 机位识别 (`_determine_camera_position()`)

通过分析粘连物轨迹的平均x坐标位置来判断机位：

- **左机位**：熔池呈左半圆，物体主要出现在视频左半部分
- **右机位**：熔池呈右半圆，物体主要出现在视频右半部分

机位判断结果会被缓存，避免重复计算。

#### 2.2 脱落位置判断 (`_determine_drop_location()`)

综合考虑多个因素：

**主要判断依据（按优先级）：**

1. **机位 + 水平移动方向**（最重要）
   - 左机位：
     - 往左移动（delta_x < 0）→ 结晶器捕获
     - 往右移动（delta_x > 0）→ 熔池
   - 右机位：
     - 往左移动（delta_x < 0）→ 熔池
     - 往右移动（delta_x > 0）→ 结晶器捕获
   - 阈值：水平移动至少20像素才判断

2. **垂直方向运动**（辅助判断）
   - 向下移动 > 50px → 熔池
   - 向上移动 > 30px → 结晶器捕获

3. **最终位置**（兜底判断）
   - y > 700 → 熔池
   - y < 400 → 结晶器捕获

**判断流程：**

```
轨迹分析
    ↓
判断机位（LEFT/RIGHT）
    ↓
计算水平移动方向 (delta_x)
    ↓
根据机位和方向判断 ──→ 有明显水平移动？
    ↓ 否                     ↓ 是
垂直方向判断          返回结果（POOL/CRUCIBLE）
    ↓
最终位置判断
    ↓
返回结果
```

**日志输出：**
每次判断会输出详细的debug日志，包括：

- 检测到的机位
- 移动方向和距离
- 判断依据和结果

---

## 代码改动文件

- `analyzer/event_detector.py`
  - 添加 `camera_position` 成员变量
  - 新增 `_determine_camera_position()` 方法
  - 重写 `_determine_drop_location()` 方法
  - 修改 `process_detections()` 方法中的持续事件处理逻辑
  - 修改 `finalize_events()` 方法

---

## 测试建议

1. **机位识别测试**
   - 使用左机位视频，验证能正确识别为 LEFT
   - 使用右机位视频，验证能正确识别为 RIGHT

2. **脱落位置测试**
   - 左机位 + 向左脱落 → CRUCIBLE
   - 左机位 + 向右脱落 → POOL
   - 右机位 + 向左脱落 → POOL
   - 右机位 + 向右脱落 → CRUCIBLE

3. **持续事件测试**
   - 验证辉光、边弧、爬弧、熔池未到边事件的 startFrame 和 endFrame 正确
   - 验证事件的持续时间计算准确

---

## 注意事项

1. **视频分辨率假设**
   - 当前代码假设视频宽度为1920（中心点960）
   - 如果实际视频分辨率不同，可能需要调整阈值

2. **阈值调优**
   - 水平移动阈值：20px
   - 垂直移动阈值：上50px，下30px
   - 位置阈值：上400，下700
   - 这些阈值可能需要根据实际效果调整

3. **机位缓存**
   - 机位在首次判断后会被缓存
   - 如果需要重置，需要创建新的 EventDetector 实例

---

## 后续优化建议

1. **动态视频分辨率检测**
   - 从实际视频中获取分辨率
   - 根据分辨率动态调整判断阈值

2. **更精确的熔池形状识别**
   - 使用图像处理技术检测熔池的实际形状
   - 更准确地判断机位

3. **轨迹曲率分析**
   - 分析粘连物掉落的完整轨迹曲线
   - 更准确判断是自由落体（熔池）还是被捕获（结晶器）
